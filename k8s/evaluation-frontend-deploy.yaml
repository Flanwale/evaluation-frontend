apiVersion: apps/v1
kind: Deployment
metadata:
  name: evaluation-frontend
  namespace: bmi-miva
spec:
  replicas: 1
  selector:
    matchLabels:
      app: evaluation-frontend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: evaluation-frontend
    spec:
      tolerations:
        - effect: NoExecute
          operator: Exists
      containers:
        - name: frontend
          image: harbor.vico-lab.com:4443/evaluation/evaluation-frontend:8aa55f327efe9d001c662e49932dbb7f26d1559c
          imagePullPolicy: Always
          ports:
            - containerPort: 3000

          env:
            - name: NODE_ENV
              value: "production"

            # 仍然用你现有的 DB Secret
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: eval-db-secret
                  key: DATABASE_URL

            # 其余全部改为 Secret: eval-frontend-secret
            - name: BETTER_AUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: BETTER_AUTH_SECRET

            - name: BETTER_AUTH_URL
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: BETTER_AUTH_URL

            - name: SMS_PROVIDER
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: SMS_PROVIDER

            - name: SPUG_URL
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: SPUG_URL

            - name: SPUG_NAME
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: SPUG_NAME

            - name: ALIYUN_SMS_SIGN_NAME
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: ALIYUN_SMS_SIGN_NAME

            - name: ALIYUN_SMS_TEMPLATE_CODE
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: ALIYUN_SMS_TEMPLATE_CODE

            - name: ALIYUN_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: ALIYUN_ACCESS_KEY_ID

            - name: ALIYUN_ACCESS_KEY_SECRET
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: ALIYUN_ACCESS_KEY_SECRET

            - name: NEXT_PUBLIC_TURNSTILE_SITE_KEY
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: NEXT_PUBLIC_TURNSTILE_SITE_KEY

            - name: TURNSTILE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: TURNSTILE_SECRET_KEY

            - name: DISABLE_TURNSTILE
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: DISABLE_TURNSTILE

            - name: NEXT_PUBLIC_DISABLE_TURNSTILE
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: NEXT_PUBLIC_DISABLE_TURNSTILE

            - name: BACKEND_ORIGIN
              valueFrom:
                secretKeyRef:
                  name: eval-frontend-secret
                  key: BACKEND_ORIGIN

          volumeMounts:
            - mountPath: /mnt/data.miva
              name: data-miva
            - mountPath: /dev/shm
              name: shm-volume

      volumes:
        - name: data-miva
          persistentVolumeClaim:
            claimName: pvc-data.wfs.miva
        - name: shm-volume
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi
